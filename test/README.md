# Тестовый бот — инструкция

Один проект, два окружения: **прод** (ветка `main`, файл `.env`) и **тест** (ветка `test`, файл `test/.env.test`). Тестовый бот — отдельный бот в Telegram (другой токен) и отдельная БД; прод не затрагивается.

Все файлы тестового бота хранятся в папке `test/`.

---

## 1. Ветка test

- Ветка для разработки и теста называется **`test`**.
- Создать ветку (один раз):  
  `git checkout -b test`  
  Затем при необходимости:  
  `git push -u origin test`
- Переключиться на тестовую ветку:  
  `git checkout test`
- Работать с новой фичей: все коммиты делай в ветку `test`.

---

## 2. Настройка тестового бота (один раз)

### 2.1. Локальная PostgreSQL

**Установка (macOS, Homebrew):**

```bash
brew install postgresql
brew services start postgresql
```

**Создание тестовой базы:**

```bash
createdb yogadaily_test
```

Или через `psql`:

```bash
psql postgres -c "CREATE DATABASE yogadaily_test;"
```

При необходимости создай отдельного пользователя и выдай права на БД (или используй текущего пользователя ОС).

### 2.2. Файл конфигурации тестового бота

1. Скопируй шаблон в `test/.env.test`:  
   `cp test/env.test.example test/.env.test`

2. Открой `test/.env.test` и заполни:
   - **`BOT_TOKEN=`** — вставь сюда токен тестового бота (значение после `=` без пробелов). Токен тестового бота вставляется **только** в файл `test/.env.test` в переменную `BOT_TOKEN=`.
   - **`POSTGRESQL_USER=`** — пользователь PostgreSQL (например, текущий пользователь ОС).
   - **`POSTGRESQL_PASSWORD=`** — пароль (можно оставить пустым при локальной peer-аутентификации).

3. Файл `test/.env.test` не коммитится (он в `.gitignore`).

---

## 3. Запуск тестового бота

Из корня проекта (при необходимости активируй venv):

```bash
./test/run_test.sh
```

Скрипт подставляет конфиг `test/.env.test` и запускает бота. Чтобы тестировать код из ветки `test`, перед запуском переключись на неё:  
`git checkout test`.

---

## 4. Продовый бот

- Ветка: **`main`**
- Конфиг: **`.env`** (в корне проекта)
- Запуск:  
  `python app/main.py`  
  (или как указано в основном README).  
Продовый бот не использует скрипт `test/run_test.sh` и не читает `test/.env.test`.

**Важно:** в прод-окружении (k8s, deploy) не устанавливай переменную `ENV_FILE`.

---

## 5. Перенос фичи из теста в прод (мерж в main)

1. Убедись, что все изменения закоммичены в ветку `test`:  
   `git status`
2. Переключись на `main`:  
   `git checkout main`
3. Смержи ветку `test` в `main`:  
   `git merge test`
4. При необходимости запушь:  
   `git push origin main`

Дальше прод обновится по вашему CI/CD (деплой из `main`).

---

## 6. Важно

- Не коммитить `.env` и `test/.env.test` — они в `.gitignore`.
- Тестовый бот — отдельный бот в Telegram (другой токен) и отдельная БД; прод не затрагивается.
- Для разработки новой фичи: ветка `test`, коммиты в `test`, запуск тестового бота через `./test/run_test.sh`. Когда фича готова — мерж `test` в `main` по шагам выше.
